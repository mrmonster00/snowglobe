<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Snow Globe</title>

  <!-- Optional: makes it feel like an app when added to iOS Home Screen -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <style>
    html, body { margin:0; height:100%; background:#000; overflow:hidden; }
    canvas { display:block; width:100vw; height:100vh; touch-action:manipulation; }

    .hint {
      position:fixed; left:12px; bottom:12px; right:12px;
      color:#fff; font:14px/1.3 system-ui, -apple-system, Segoe UI, Roboto, Arial;
      opacity:.88;
      background:rgba(0,0,0,.35); padding:10px 12px; border-radius:12px;
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
    }

    .btn {
      position:fixed; top:12px; right:12px;
      color:#fff; font:14px system-ui;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.25);
      padding:10px 12px; border-radius:12px;
    }

    .btn:disabled { opacity:.6; }
  </style>
</head>
<body>
  <canvas id="c"></canvas>
  <button class="btn" id="enableMotion">Enable Shake</button>
  <div class="hint" id="hint">Tap/click to “shake” the globe. On iPhone, press <b>Enable Shake</b> once.</div>

<script>
(() => {
  const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d", { alpha: false });
  const btn = document.getElementById("enableMotion");
  const hint = document.getElementById("hint");

  // ✅ Put your image in the same GitHub repo folder named EXACTLY "photo.png"
  const img = new Image();
  img.src = "photo.png";

  // Snow particles
  const flakes = [];
  const MAX_FLAKES = 900;

  let width = 0, height = 0, dpr = 1;

  // Snow physics
  let burst = 0;           // energy added by tap/shake
  let wind = 0;            // horizontal drift
  const gravity = 0.55;    // base fall speed

  function resize() {
    dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    width = Math.floor(window.innerWidth * dpr);
    height = Math.floor(window.innerHeight * dpr);
    canvas.width = width;
    canvas.height = height;
  }

  // ✅ Ensure proper resize on rotate (iOS needs a delay)
  window.addEventListener("resize", resize);
  window.addEventListener("orientationchange", () => setTimeout(resize, 300));
  resize();

  function orientationHint() {
    if (window.innerHeight > window.innerWidth) {
      hint.innerHTML = "Rotate phone for a wider view ❄️ Tap to shake. On iPhone, press <b>Enable Shake</b> once.";
    } else {
      hint.innerHTML = "Tap/click to “shake” the globe. On iPhone, press <b>Enable Shake</b> once.";
    }
  }
  window.addEventListener("resize", orientationHint);
  window.addEventListener("orientationchange", () => setTimeout(orientationHint, 350));
  orientationHint();

  function rand(min, max) { return Math.random() * (max - min) + min; }

  function addFlake(count, xCenter = width/2, yStart = -20*dpr) {
    for (let i = 0; i < count && flakes.length < MAX_FLAKES; i++) {
      const r = rand(1.2, 4.4) * dpr;
      flakes.push({
        x: xCenter + rand(-width*0.45, width*0.45),
        y: yStart + rand(-height*0.25, 0),
        r,
        vy: rand(0.3, 1.25) * dpr,
        vx: rand(-0.35, 0.35) * dpr,
        wob: rand(0, Math.PI*2),
        wobSpeed: rand(0.006, 0.02),
        opacity: rand(0.55, 0.95)
      });
    }
  }

  // Initial snow
  addFlake(300, width/2, rand(0, height));

  function burstSnow(strength = 1) {
    burst = Math.min(2.0, burst + 0.55 * strength);
    wind += rand(-1.7, 1.7) * dpr * strength;
    addFlake(Math.floor(90 * strength), width/2, -30*dpr);
  }

  // Tap / click to shake
  function onTap(e) {
    const x = (e.touches ? e.touches[0].clientX : e.clientX) * dpr;
    burstSnow(1);
    addFlake(60, x, -30*dpr);
  }
  canvas.addEventListener("click", onTap);
  canvas.addEventListener("touchstart", onTap, { passive: true });

  // Device motion (shake)
  let lastShakeAt = 0;
  function handleMotion(ev) {
    const a = ev.accelerationIncludingGravity;
    if (!a) return;
    const ax = a.x || 0, ay = a.y || 0, az = a.z || 0;

    // Shake intensity (rough)
    const mag = Math.sqrt(ax*ax + ay*ay + az*az);
    const intensity = Math.max(0, mag - 11);

    const now = performance.now();
    if (intensity > 2.2 && now - lastShakeAt > 180) {
      lastShakeAt = now;
      burstSnow(Math.min(1.7, intensity / 6));
    }

    // Tilt affects wind slightly
    wind += (ax * 0.02) * dpr;
  }

  // iOS requires permission
  btn.addEventListener("click", async () => {
    try {
      if (typeof DeviceMotionEvent !== "undefined" &&
          typeof DeviceMotionEvent.requestPermission === "function") {
        const res = await DeviceMotionEvent.requestPermission();
        if (res !== "granted") throw new Error("Permission not granted");
      }
      window.addEventListener("devicemotion", handleMotion);
      btn.textContent = "Shake Enabled";
      btn.disabled = true;
    } catch (e) {
      btn.textContent = "Motion Blocked";
      console.warn(e);
      alert("Motion access was blocked. You can still tap the screen to shake the snow.");
    }
  });

  function drawBackground() {
    if (!img.complete || !img.naturalWidth) return;

    // Cover draw (like background-size: cover)
    const iw = img.naturalWidth * dpr;
    const ih = img.naturalHeight * dpr;

    const scale = Math.max(width / iw, height / ih);
    const dw = iw * scale;
    const dh = ih * scale;
    const dx = (width - dw) / 2;
    const dy = (height - dh) / 2;

    ctx.drawImage(img, dx, dy, dw, dh);

    // Subtle vignette
    const g = ctx.createRadialGradient(
      width/2, height/2, Math.min(width,height)*0.22,
      width/2, height/2, Math.max(width,height)*0.7
    );
    g.addColorStop(0, "rgba(0,0,0,0)");
    g.addColorStop(1, "rgba(0,0,0,0.35)");
    ctx.fillStyle = g;
    ctx.fillRect(0, 0, width, height);
  }

  function step() {
    // Clear + photo
    ctx.fillStyle = "#000";
    ctx.fillRect(0, 0, width, height);
    drawBackground();

    // Decay burst and wind
    burst *= 0.93;
    wind *= 0.985;

    // Add some flakes while burst is active
    if (burst > 0.05) addFlake(Math.floor(8 + 30 * burst), width/2, -30*dpr);

    // Update + draw flakes
    for (let i = flakes.length - 1; i >= 0; i--) {
      const f = flakes[i];

      f.wob += f.wobSpeed;
      const wobX = Math.sin(f.wob) * 0.55 * dpr;

      const fall = (gravity + f.vy) * (1 + burst * 1.2);
      f.y += fall;
      f.x += (f.vx + wind * 0.02) + wobX;

      // recycle
      if (f.y - f.r > height) {
        f.y = -rand(10, 120) * dpr;
        f.x = rand(0, width);
      }
      if (f.x < -50*dpr) f.x = width + 50*dpr;
      if (f.x > width + 50*dpr) f.x = -50*dpr;

      ctx.beginPath();
      ctx.arc(f.x, f.y, f.r, 0, Math.PI * 2);
      ctx.fillStyle = `rgba(255,255,255,${f.opacity})`;
      ctx.fill();
    }

    requestAnimationFrame(step);
  }

  img.onload = () => requestAnimationFrame(step);
  img.onerror = () => {
    alert('Could not load "photo.png". Upload it to the same folder as index.html and name it exactly photo.png');
    requestAnimationFrame(step);
  };
})();
</script>
</body>
</html>
